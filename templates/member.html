<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<title>ã‚¿ã‚¹ã‚¯é€²æ—ç®¡ç†</title>
	<link rel="stylesheet" th:href="@{/css/member.css}" />
</head>

<body th:classappend="${backgroundBase64} ? 'custom-background'"
	th:style="${backgroundBase64} ? 'background-image: url(data:' + ${backgroundImageType} + ';base64,' + ${backgroundBase64} + ');' : ''">

	<div th:replace="fragments/header :: header"></div>

	<h1>ã‚¿ã‚¹ã‚¯é€²æ—ç®¡ç†</h1>

	<!-- ğŸ”” ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
	<div th:if="${success != null}" class="alert alert-success" style="margin: 10px 0;">
		<p th:text="${success}"></p>
	</div>
	<div th:if="${error != null}" class="alert alert-danger" style="margin: 10px 0;">
		<p th:text="${error}"></p>
	</div>

	<label for="fontSizeSelector">æ–‡å­—ã‚µã‚¤ã‚º:</label>
	<select id="fontSizeSelector">
		<option value="small">å°</option>
		<option value="medium" selected>ä¸­</option>
		<option value="large">å¤§</option>
	</select>

	<!-- èƒŒæ™¯ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
	<form th:action="@{/member/upload-background}" method="post" enctype="multipart/form-data"
		style="margin-bottom: 20px;">
		<p style="color: #666; font-size: 0.9em;">
			â€» èƒŒæ™¯ç”»åƒã¯ <strong>5MB ä»¥ä¸‹</strong>ã€<strong>JPEG / PNG</strong> å½¢å¼ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚
		</p>
		<label>èƒŒæ™¯ç”»åƒã‚’é¸æŠ:
			<input type="file" name="backgroundImage" accept="image/jpeg,image/png" required />
		</label>
		<button type="submit">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
	</form>

	<div class="section-title" th:text="'ã€' + ${loginUserName} + 'ã€‘ã®ã‚¿ã‚¹ã‚¯'"></div>
	<form th:action="@{/member}" method="post">
		<button type="button" id="save-button">ä¿å­˜</button>
		<table>
			<thead>
				<tr>
					<th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
					<th>ã‚¿ã‚¹ã‚¯å</th>
					<th>é–‹å§‹æ—¥</th> <!-- å¤‰æ›´ -->
					<th>çµ‚äº†æ—¥</th> <!-- è¿½åŠ  -->
					<th>æ‹…å½“è€…</th>
					<th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
					<th>é€²æ—ç‡</th>
					<th>å‚™è€ƒ</th>
					<th>ãƒªãƒ¼ãƒ€ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="task : ${myTasks}">
					<td th:text="${task.project.projectName}"></td>
					<td th:text="${task.taskName}"></td>
					<td th:text="${task.startDate}"></td> <!-- é–‹å§‹æ—¥ -->
					<td th:text="${task.endDate}"></td> <!-- çµ‚äº†æ—¥ -->
					<td th:text="${task.user.name}"></td>
					<td>
						<select th:name="'status_' + ${task.taskId}" th:onchange="updateProgressBar(this)">
							<option th:each="status : ${statusList}" th:value="${status}" th:text="${status}"
								th:selected="${status == task.status}"></option>
						</select>
					</td>
					<td>
						<div class="progress-bar">
							<div class="progress" th:id="'progress-' + ${task.taskId}"
								th:style="'width:' + ${task.progress} + '%'" th:text="${task.progress} + '%'">
							</div>
						</div>
					</td>
					<td th:text="${task.description} ?: ''"></td>
					<td class="alert-cell" th:text="${taskAlerts[task.taskId]} ?: ''"></td>
				</tr>
			</tbody>
		</table>
	</form>

	<div class="section-title">ä»–ã®æ–¹ã®ã‚¿ã‚¹ã‚¯</div>
	<div class="controls">
		<label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:
			<select id="others-project-select" onchange="filterOthersTasks()">
				<option value="">å…¨ã¦</option>
				<option th:each="project : ${projects}" th:value="${project.projectId}" th:text="${project.projectName}"
					th:selected="${project.projectId == selectedProjectId}"></option>
			</select>
		</label>
		<label>ãƒ¦ãƒ¼ã‚¶ãƒ¼:
			<select id="others-user-select" onchange="filterOthersTasks()">
				<option value="">å…¨ã¦</option>
				<option th:each="otherUser : ${users}" th:value="${otherUser.userId}" th:text="${otherUser.name}"
					th:selected="${otherUser.userId == selectedUserId}"></option>
			</select>
		</label>
	</div>

	<table>
		<thead>
			<tr>
				<th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
				<th>ã‚¿ã‚¹ã‚¯å</th>
				<th>é–‹å§‹æ—¥</th> <!-- å¤‰æ›´ -->
				<th>çµ‚äº†æ—¥</th> <!-- è¿½åŠ  -->
				<th>æ‹…å½“è€…</th>
				<th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
				<th>é€²æ—ç‡</th>
				<th>å‚™è€ƒ</th>
				<th>ãƒªãƒ¼ãƒ€ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
			</tr>
		</thead>
		<tbody>
			<tr th:each="otherTask : ${otherTasks}">
				<td th:text="${otherTask.project.projectName}"></td>
				<td th:text="${otherTask.taskName}"></td>
				<td th:text="${otherTask.startDate}"></td> <!-- é–‹å§‹æ—¥ -->
				<td th:text="${otherTask.endDate}"></td> <!-- çµ‚äº†æ—¥ -->
				<td th:text="${otherTask.user.name}"></td>
				<td th:text="${otherTask.status}"></td>
				<td>
					<div class="progress-bar">
						<div class="progress" th:style="'width:' + ${otherTask.progress} + '%'"
							th:text="${otherTask.progress} + '%'">
						</div>
					</div>
				</td>
				<td th:text="${otherTask.description} ?: ''"></td>
				<td class="alert-cell" th:text="${taskAlerts[otherTask.taskId]} ?: ''"></td>
			</tr>
		</tbody>
	</table>

	<script>
		const statusToProgress = {
			"æœªç€æ‰‹": 0,
			"ç€æ‰‹": 30,
			"é€²è¡Œä¸­": 60,
			"ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡": 90,
			"å®Œäº†": 100
		};

		function updateProgressBar(selectElem) {
			const taskId = selectElem.name.substring(7);
			const progressDiv = document.getElementById('progress-' + taskId);
			const status = selectElem.value;
			const progressValue = statusToProgress[status] || 0;
			progressDiv.style.width = progressValue + '%';
			progressDiv.textContent = progressValue + '%';
		}

		function filterOthersTasks() {
			const projectId = document.getElementById('others-project-select').value;
			const userId = document.getElementById('others-user-select').value;
			let query = '?';
			if (projectId) query += 'projectId=' + encodeURIComponent(projectId) + '&';
			if (userId) query += 'userId=' + encodeURIComponent(userId);
			window.location.href = '/member' + query;
		}

		document.addEventListener("DOMContentLoaded", () => {
			const saveButton = document.getElementById("save-button");
			const form = document.querySelector('form[action="/member"]');

			if (saveButton && form) {
				saveButton.addEventListener("click", () => {
					const sound = new Audio("/sound/coin.mp3");
					sound.preload = "auto";

					sound.play().catch(err => {
						console.warn("ä¿å­˜éŸ³ãŒå†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸ:", err);
						form.submit();
						return;
					});

					setTimeout(() => {
						form.submit();
					}, 800);
				});
			}

			const fontSelector = document.getElementById('fontSizeSelector');
			if (!fontSelector) return;

			const savedSize = localStorage.getItem('preferredFontSize') || 'medium';
			document.body.classList.add(savedSize + '-font');
			fontSelector.value = savedSize;

			fontSelector.addEventListener('change', function () {
				document.body.classList.remove('small-font', 'medium-font', 'large-font');
				document.body.classList.add(this.value + '-font');
				localStorage.setItem('preferredFontSize', this.value);
			});
		});
	</script>

</body>

</html>